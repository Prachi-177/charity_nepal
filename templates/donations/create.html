{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

{% block title %}Donate to {{ case.title }} - CharityNepal{% endblock %}

{% block extra_css %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<style>
    /* CharityNepal Color Palette */
    :root {
        --cn-green-50: #f0fdf4;
        --cn-green-100: #dcfce7;
        --cn-green-200: #bbf7d0;
        --cn-green-300: #86efac;
        --cn-green-400: #4ade80;
        --cn-green-500: #22c55e;
        --cn-green-600: #16a34a;
        --cn-green-700: #15803d;
        --cn-green-800: #166534;
        --cn-green-900: #14532d;
        --cn-dark: #1e293b;
        --cn-muted: #64748b;
    }

    /* Page Background */
    body {
        background: linear-gradient(135deg, #f8fafc 0%, var(--cn-green-50) 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    /* Hero Pattern Background */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image:
            radial-gradient(rgba(34, 197, 94, 0.08) 2px, transparent 2px),
            radial-gradient(rgba(59, 130, 246, 0.08) 1px, transparent 1px);
        background-size: 60px 60px, 30px 30px;
        background-position: 0 0, 15px 15px;
        z-index: -2;
        opacity: 0.4;
    }

    /* Floating Background Shapes */
    .floating-shape {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.05));
        border-radius: 50%;
        position: absolute;
        animation: float 12s ease-in-out infinite;
        z-index: -1;
        filter: blur(1px);
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0) rotate(0deg);
            opacity: 0.3;
        }

        50% {
            transform: translateY(-40px) rotate(180deg);
            opacity: 0.6;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(40px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }

        100% {
            background-position: 200% 0;
        }
    }

    /* Glass Effect Cards */
    .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.1),
            0 8px 25px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .donation-card {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-left: 6px solid var(--cn-green-600);
        box-shadow:
            0 25px 60px rgba(34, 197, 94, 0.15),
            0 10px 30px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    /* Enhanced Buttons */
    .btn-hover {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(0);
        position: relative;
        overflow: hidden;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-hover::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent);
        transition: left 0.6s ease;
    }

    .btn-hover:hover::before {
        left: 100%;
    }

    .btn-hover:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.15),
            0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .btn-hover:active {
        transform: translateY(-1px) scale(1.01);
    }

    /* Enhanced Form Elements */
    .form-input {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(229, 231, 235, 0.8);
        border-radius: 16px;
        padding: 16px 20px;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        width: 100%;
    }

    .form-input:focus {
        border-color: var(--cn-green-600);
        outline: none;
        box-shadow:
            0 0 0 4px rgba(34, 197, 94, 0.1),
            0 8px 25px rgba(34, 197, 94, 0.15);
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 1);
    }

    /* Payment Method Cards */
    .payment-method {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 2px solid rgba(229, 231, 235, 0.8);
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .payment-method:hover {
        border-color: var(--cn-green-500);
        transform: translateY(-4px) scale(1.02);
        box-shadow:
            0 20px 40px rgba(34, 197, 94, 0.15),
            0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .payment-method.selected {
        border-color: var(--cn-green-600);
        background: linear-gradient(135deg,
                rgba(34, 197, 94, 0.1),
                rgba(34, 197, 94, 0.05));
        box-shadow:
            0 20px 40px rgba(34, 197, 94, 0.2),
            0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .payment-method::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent);
        transition: left 0.6s ease;
    }

    .payment-method:hover::before {
        left: 100%;
    }

    /* Donation Amount Buttons */
    .amount-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(34, 197, 94, 0.3);
        border-radius: 16px;
        padding: 16px 24px;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--cn-green-700);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .amount-btn:hover {
        border-color: var(--cn-green-600);
        background: rgba(34, 197, 94, 0.1);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.2);
    }

    .amount-btn.selected {
        background: linear-gradient(135deg, var(--cn-green-600), var(--cn-green-700));
        border-color: var(--cn-green-600);
        color: white;
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
    }

    /* Case Preview */
    .case-preview {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 24px;
        padding: 32px;
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.06),
            0 8px 25px rgba(0, 0, 0, 0.04);
        animation: slideUp 0.8s ease-out;
    }

    /* Progress Bar */
    .progress-container {
        background: rgba(229, 231, 235, 0.5);
        border-radius: 20px;
        height: 16px;
        overflow: hidden;
        position: relative;
    }

    .progress-bar {
        background: linear-gradient(90deg, var(--cn-green-500), var(--cn-green-600));
        height: 100%;
        border-radius: 20px;
        transition: width 1s ease-in-out;
        position: relative;
        overflow: hidden;
    }

    .progress-bar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent);
        animation: shimmer 2s infinite;
    }

    /* Typography Enhancement */
    h1,
    h2,
    h3,
    h4 {
        font-weight: 800;
        color: var(--cn-dark);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .gradient-text {
        background: linear-gradient(135deg, var(--cn-green-600), var(--cn-green-700));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Responsive */
    @media (max-width: 768px) {

        .glass-effect,
        .donation-card,
        .case-preview {
            margin: 16px;
            padding: 24px;
        }

        .btn-hover {
            padding: 16px 24px;
            font-size: 0.9rem;
        }

        h1 {
            font-size: 2rem;
        }

        h2 {
            font-size: 1.5rem;
        }

        .floating-shape {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="donation-app">
    <!-- Floating Background Shapes -->
    <div class="floating-shape" style="width: 300px; height: 300px; top: -100px; left: -150px; animation-delay: -2s;"></div>
    <div class="floating-shape" style="width: 200px; height: 200px; top: 20%; right: -100px; animation-delay: -4s;"></div>
    <div class="floating-shape" style="width: 250px; height: 250px; bottom: -125px; left: 30%; animation-delay: -6s;"></div>

    <section class="relative min-h-screen py-12 md:py-20">
        <div class="container mx-auto px-4 max-w-7xl relative z-10">

        <!-- Breadcrumb Navigation -->
        <div class="mb-8" style="animation: slideUp 0.5s ease-out;">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="{% url 'home' %}" class="text-cn-muted hover:text-cn-green-600 transition-colors">
                    <i class="fas fa-home mr-1"></i>Home
                </a>
                <i class="fas fa-chevron-right text-cn-muted text-xs"></i>
                <a href="{% url 'cases:list' %}" class="text-cn-muted hover:text-cn-green-600 transition-colors">
                    Campaigns
                </a>
                <i class="fas fa-chevron-right text-cn-muted text-xs"></i>
                <span class="text-cn-green-600 font-semibold">Donate</span>
            </nav>
        </div>

        <div class="grid grid-cols-1 gap-8 lg:gap-12 max-w-4xl mx-auto">

            <!-- Case Information -->
            <div class="space-y-6">
                <!-- Case Preview Card -->
                <div class="case-preview rounded-3xl overflow-hidden" style="animation: slideUp 0.7s ease-out;">
                    {% if case.featured_image %}
                    <div class="relative h-96 overflow-hidden">
                        <img src="{{ case.featured_image.url }}" alt="{{ case.title }}"
                            class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent"></div>
                    </div>
                    {% endif %}

                    <div class="p-8">
                        <!-- Category & Status Badges -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="inline-flex items-center bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wide">
                                <i class="fas fa-tag mr-2"></i>
                                {{ case.get_category_display }}
                            </div>
                            <div class="text-xs font-bold text-cn-green-600 uppercase tracking-wide">
                                <i class="fas fa-check-circle mr-1"></i>Verified
                            </div>
                        </div>

                        <!-- Title & Description -->
                        <h2 class="text-4xl font-bold text-gray-900 mb-4">{{ case.title }}</h2>
                        <p class="text-gray-600 leading-relaxed text-lg mb-8">{{ case.description|truncatewords:80 }}</p>

                        <!-- Progress Section -->
                        <div class="bg-gray-50 rounded-2xl p-8 mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Campaign Progress</h3>
                                <span class="text-3xl font-black text-cn-green-600">{{ case.completion_percentage|floatformat:1 }}%</span>
                            </div>
                            <div class="progress-container mb-6">
                                <div class="progress-bar" style="width: {{ case.completion_percentage }}%"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-6 text-center">
                                <div>
                                    <p class="text-gray-500 text-xs font-semibold mb-2 uppercase tracking-wide">RAISED</p>
                                    <p class="text-2xl font-bold text-gray-900">Rs. {{ case.collected_amount|floatformat:0 }}</p>
                                </div>
                                <div class="border-l border-r border-gray-200">
                                    <p class="text-gray-500 text-xs font-semibold mb-2 uppercase tracking-wide">GOAL</p>
                                    <p class="text-2xl font-bold text-gray-900">Rs. {{ case.target_amount|floatformat:0 }}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-xs font-semibold mb-2 uppercase tracking-wide">DONORS</p>
                                    <p class="text-2xl font-bold text-gray-900">{{ case.donations.count }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <p class="text-xs text-gray-500 font-semibold uppercase mb-2">Active Since</p>
                                <p class="text-lg font-bold text-gray-900">{{ case.created_at|timesince }} ago</p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl">
                                <p class="text-xs text-gray-500 font-semibold uppercase mb-2">Priority</p>
                                <p class="text-lg font-bold">
                                    <span v-if="'{{ case.urgency_flag }}'=='critical'" class="text-red-600">ðŸ”´ Critical</span>
                                    <span v-else-if="'{{ case.urgency_flag }}'=='high'" class="text-orange-600">ðŸŸ  High</span>
                                    <span v-else class="text-green-600">ðŸŸ¢ Normal</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Donation Form -->
            <div>
                <div class="donation-card rounded-3xl" style="animation: slideUp 0.9s ease-out;">
                    <div class="p-8">
                        <!-- Form Header -->
                        <div class="mb-8 text-center">
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">Ready to Make a Donation?</h2>
                            <p class="text-gray-600">Secure payment powered by Khalti</p>
                        </div>

                        <!-- Vue.js Donation Form -->
                        <form method="POST" @submit.prevent="handleSubmit" class="space-y-6" id="donation-form">
                            {% csrf_token %}

                            <!-- Amount Section -->
                            <div class="space-y-3">
                                <label class="block text-sm font-bold text-gray-900">Donation Amount</label>
                                
                                <!-- Pre-filled Amount Display -->
                                <div class="space-y-3" v-if="prefilled_amount">
                                    <div class="bg-gradient-to-r from-cn-green-50 to-cn-green-100 p-4 rounded-2xl border-2 border-cn-green-500">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-xs text-gray-600 font-semibold mb-1">AMOUNT</p>
                                                <p class="text-3xl font-bold text-cn-green-700">Rs. {{ "{" }}{{ "{" }} prefilled_amount {{ "}" }}{{ "}" }}</p>
                                            </div>
                                            <i class="fas fa-check-circle text-cn-green-500 text-3xl"></i>
                                        </div>
                                    </div>
                                    <input type="hidden" name="amount" :value="prefilled_amount">
                                </div>

                                <!-- Quick Amount Buttons -->
                                <div v-else class="space-y-3">
                                    <div class="grid grid-cols-4 gap-2">
                                        <button 
                                            v-for="amt in quickAmounts" 
                                            :key="amt"
                                            @click="selectAmount(amt)"
                                            :class="['amount-btn text-sm py-3', { 'selected': form.amount === amt }]"
                                            type="button">
                                            {{ "{" }}{{ "{" }} formatAmount(amt) {{ "}" }}{{ "}" }}
                                        </button>
                                    </div>
                                    
                                    <!-- Custom Amount Input -->
                                    <div class="relative">
                                        <input 
                                            v-model.number="form.amount" 
                                            type="number" 
                                            name="amount"
                                            class="form-input text-lg"
                                            placeholder="Custom amount"
                                            min="50">
                                        <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 font-semibold text-sm">NPR</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="space-y-3">
                                <label class="block text-sm font-bold text-gray-900">Payment Method</label>
                                <div 
                                    @click="form.payment_method = 'khalti'"
                                    :class="['payment-method cursor-pointer', { 'selected': form.payment_method === 'khalti' }]">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-7 flex-shrink-0 flex items-center justify-center">
                                            <svg class="w-full h-full" viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg">
                                                <rect width="100" height="50" fill="#5c2d91" rx="4" />
                                                <text x="50" y="32" font-size="20" font-weight="bold" fill="white" text-anchor="middle" font-family="Arial, sans-serif">K</text>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-900">Khalti</p>
                                            <p class="text-xs text-gray-500">Wallet & Banking</p>
                                        </div>
                                        <i class="fas fa-check-circle text-cn-green-600" v-if="form.payment_method === 'khalti'"></i>
                                    </div>
                                </div>
                                <input type="hidden" name="payment_method" :value="form.payment_method">
                            </div>

                            <!-- Donor Information (if not authenticated) -->
                            <div v-if="!isAuthenticated" class="border-t pt-6">
                                <h3 class="text-sm font-bold text-gray-900 mb-4">Your Information</h3>
                                <div class="space-y-3">
                                    <!-- Donor Name -->
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                                            Full Name <span class="text-red-600">*</span>
                                        </label>
                                        <div class="relative">
                                            <input 
                                                v-model="form.donor_name" 
                                                type="text"
                                                name="donor_name"
                                                class="form-input"
                                                :class="{ 'border-red-500 bg-red-50': errors.donor_name }"
                                                @blur="validateDonorName"
                                                @input="clearNameError"
                                                placeholder="John Doe"
                                                v-show="!form.is_anonymous">
                                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2" v-show="!form.is_anonymous">
                                                <i :class="['fas', errors.donor_name ? 'fa-exclamation-circle text-red-600' : 'fa-check-circle text-gray-300']"></i>
                                            </div>
                                        </div>
                                        <p v-if="errors.donor_name && !form.is_anonymous" class="text-red-600 text-xs mt-1 font-medium">
                                            {{ "{" }}{{ "{" }} errors.donor_name {{ "}" }}{{ "}" }}
                                        </p>
                                    </div>

                                    <!-- Donor Email -->
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                                            Email Address <span class="text-red-600">*</span>
                                        </label>
                                        <div class="relative">
                                            <input 
                                                v-model="form.donor_email" 
                                                type="email"
                                                name="donor_email"
                                                class="form-input"
                                                :class="{ 'border-red-500 bg-red-50': errors.donor_email }"
                                                @blur="validateDonorEmail"
                                                @input="clearEmailError"
                                                placeholder="john@example.com"
                                                v-show="!form.is_anonymous">
                                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2" v-show="!form.is_anonymous">
                                                <i :class="['fas', errors.donor_email ? 'fa-exclamation-circle text-red-600' : 'fa-check-circle text-gray-300']"></i>
                                            </div>
                                        </div>
                                        <p v-if="errors.donor_email && !form.is_anonymous" class="text-red-600 text-xs mt-1 font-medium">
                                            {{ "{" }}{{ "{" }} errors.donor_email {{ "}" }}{{ "}" }}
                                        </p>
                                    </div>

                                    <!-- Anonymous Checkbox -->
                                    <div class="flex items-center space-x-3 pt-2">
                                        <input 
                                            v-model="form.is_anonymous" 
                                            type="checkbox" 
                                            name="is_anonymous" 
                                            id="anonymous-donate"
                                            class="w-4 h-4 rounded border-gray-300 text-cn-green-600 cursor-pointer"
                                            value="on">
                                        <label for="anonymous-donate" class="text-sm text-gray-700 font-medium cursor-pointer">
                                            Donate anonymously
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Message (Optional) -->
                            <div class="border-t pt-6">
                                <label class="block text-xs font-bold text-gray-700 mb-2 uppercase tracking-wide">
                                    Message <span class="text-gray-400 font-normal">(Optional)</span>
                                </label>
                                <textarea 
                                    v-model="form.donor_message" 
                                    name="donor_message"
                                    class="form-input resize-none" 
                                    rows="3"
                                    placeholder="Your message of support..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="pt-2">
                                <button 
                                    type="submit"
                                    :disabled="isSubmitting"
                                    class="btn-hover w-full bg-gradient-to-r from-cn-green-600 to-cn-green-700 hover:from-cn-green-700 hover:to-cn-green-800 text-white font-bold py-4 px-6 rounded-xl text-base shadow-lg disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                                    <i v-if="!isSubmitting" class="fas fa-heart"></i>
                                    <svg v-else class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>{{ "{" }}{{ "{" }} isSubmitting ? 'Processing...' : 'Donate Now' {{ "}" }}{{ "}" }}</span>
                                </button>
                            </div>

                            <p class="text-center text-xs text-gray-500 font-medium">
                                <i class="fas fa-lock mr-1"></i>
                                Your donation is 100% secure and encrypted
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                form: {
                    amount: null,
                    payment_method: 'khalti',
                    donor_name: '',
                    donor_email: '',
                    donor_message: '',
                    is_anonymous: false
                },
                errors: {
                    donor_name: '',
                    donor_email: ''
                },
                validationErrors: [],
                isSubmitting: false,
                isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
                prefilled_amount: {% if prefilled_amount %}{{ prefilled_amount }}{% else %}null{% endif %},
                quickAmounts: [500, 1000, 2500, 5000]
            };
        },
        mounted() {
            // Set prefilled amount
            if (this.prefilled_amount) {
                this.form.amount = this.prefilled_amount;
            }

            // Check if prefilled amount is valid
            if (this.prefilled_amount && this.prefilled_amount < 50) {
                this.validationErrors.push('Minimum donation amount is Rs. 50');
            }
        },
        methods: {
            selectAmount(amount) {
                this.form.amount = amount;
            },
            formatAmount(amount) {
                return new Intl.NumberFormat('en-NP').format(amount);
            },
            validateDonorName() {
                const name = this.form.donor_name.trim();
                if (!name) {
                    this.errors.donor_name = 'Name is required';
                } else if (name.length < 2) {
                    this.errors.donor_name = 'Name must be at least 2 characters';
                } else {
                    this.errors.donor_name = '';
                }
            },
            validateDonorEmail() {
                const email = this.form.donor_email.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!email) {
                    this.errors.donor_email = 'Email is required';
                } else if (!emailRegex.test(email)) {
                    this.errors.donor_email = 'Please enter a valid email address';
                } else {
                    this.errors.donor_email = '';
                }
            },
            clearNameError() {
                if (this.form.donor_name.trim()) {
                    this.errors.donor_name = '';
                }
            },
            clearEmailError() {
                if (this.form.donor_email.trim()) {
                    this.errors.donor_email = '';
                }
            },
            handleSubmit() {
                this.validationErrors = [];
                let hasError = false;

                // Validate payment method
                if (!this.form.payment_method) {
                    this.validationErrors.push('Please select a payment method');
                    hasError = true;
                }

                // Validate amount
                const amount = this.prefilled_amount || this.form.amount;
                if (!amount || parseFloat(amount) < 50) {
                    this.validationErrors.push('Please enter a valid donation amount (minimum Rs. 50)');
                    hasError = true;
                }

                // Validate donor info if not authenticated AND not donating anonymously
                if (!this.isAuthenticated && !this.form.is_anonymous) {
                    const donorName = this.form.donor_name.trim();
                    const donorEmail = this.form.donor_email.trim();
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                    if (!donorName) {
                        this.errors.donor_name = 'Name is required';
                        hasError = true;
                    }

                    if (!donorEmail) {
                        this.errors.donor_email = 'Email is required';
                        hasError = true;
                    } else if (!emailRegex.test(donorEmail)) {
                        this.errors.donor_email = 'Invalid email format';
                        hasError = true;
                    }
                }

                if (hasError) {
                    // Scroll to first error field
                    this.$nextTick(() => {
                        const nameInput = document.querySelector('input[name="donor_name"]');
                        const emailInput = document.querySelector('input[name="donor_email"]');
                        
                        if (this.errors.donor_name && nameInput) {
                            nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            nameInput.focus();
                        } else if (this.errors.donor_email && emailInput) {
                            emailInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            emailInput.focus();
                        }
                    });
                    return;
                }

                // All validation passed - submit form
                this.isSubmitting = true;
                
                // Update all form fields with current Vue data
                const form = document.getElementById('donation-form');
                
                // Update amount field
                let amountInput = form.querySelector('input[name="amount"][type="hidden"]');
                if (!amountInput) {
                    amountInput = form.querySelector('input[name="amount"][type="number"]');
                }
                if (amountInput) {
                    amountInput.value = this.prefilled_amount || this.form.amount;
                }
                
                // Update payment method
                const paymentInput = form.querySelector('input[name="payment_method"]');
                if (paymentInput) {
                    paymentInput.value = this.form.payment_method;
                }
                
                // Update donor name
                const nameInput = form.querySelector('input[name="donor_name"]');
                if (nameInput) {
                    nameInput.value = this.form.is_anonymous ? '' : this.form.donor_name;
                }
                
                // Update donor email
                const emailInput = form.querySelector('input[name="donor_email"]');
                if (emailInput) {
                    emailInput.value = this.form.is_anonymous ? '' : this.form.donor_email;
                }
                
                // Update donor message
                const messageInput = form.querySelector('textarea[name="donor_message"]');
                if (messageInput) {
                    messageInput.value = this.form.donor_message;
                }
                
                // Update anonymous checkbox
                const anonInput = form.querySelector('input[name="is_anonymous"]');
                if (anonInput) {
                    anonInput.checked = this.form.is_anonymous;
                }
                
                // Submit the form after a short delay to ensure all values are set
                setTimeout(() => {
                    form.submit();
                }, 100);
            }
        }
    }).mount('#donation-app');
</script>
{% endblock %}